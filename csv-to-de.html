%%[
SET @jsonData = RequestParameter("jsonData")
IF NOT EMPTY(@jsonData) THEN
  SET @rowCount = 0
  SET @jsonRows = BuildRowsetFromJson(@jsonData, "$")

  FOR @i = 1 TO RowCount(@jsonRows) DO
    SET @row = Row(@jsonRows, @i)
    SET @email = Field(@row, "Email")
    SET @firstName = Field(@row, "FirstName")
    SET @lastName = Field(@row, "LastName")

    UPSERTDE("YourDataExtensionName", 1, "Email", @email, "FirstName", @firstName, "LastName", @lastName)
    SET @rowCount = Add(@rowCount, 1)
  NEXT @i

  OUTPUT(CONCAT("<p style='color:green;'>âœ… Upserted ", @rowCount, " rows into Data Extension.</p>"))
ENDIF
]%%

<h2>ðŸ“¥ Drag & Drop CSV to Convert to JSON</h2>
<div id="dropzone">Drop CSV file here</div>

<form method="post">
  <textarea name="jsonData" id="jsonData" rows="12" style="width:100%; margin-top:20px;" placeholder="JSON will appear here..."></textarea>
  <br><br>
  <input type="submit" value="Upsert to Data Extension" />
</form>

<style>
  #dropzone {
    width: 100%;
    height: 150px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    text-align: center;
    line-height: 150px;
    font-size: 18px;
    color: #666;
    margin-bottom: 20px;
  }
  #dropzone.dragover {
    border-color: #4CAF50;
    color: #4CAF50;
    background-color: #f9fff9;
  }
</style>

<script>
  const dropzone = document.getElementById('dropzone');
  const jsonField = document.getElementById('jsonData');

  dropzone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });

  dropzone.addEventListener('dragleave', function(e) {
    dropzone.classList.remove('dragover');
  });

  dropzone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type === "text/csv") {
      const reader = new FileReader();
      reader.onload = function(event) {
        const lines = event.target.result.split(/\r?\n/);
        const headers = lines[0].split(",").map(h => h.trim());
        const jsonArray = [];

        for (let i = 1; i < lines.length; i++) {
          const row = lines[i].split(",");
          if (row.length !== headers.length) continue;
          const obj = {};
          for (let j = 0; j < headers.length; j++) {
            obj[headers[j]] = row[j].trim();
          }
          jsonArray.push(obj);
        }

        jsonField.value = JSON.stringify(jsonArray, null, 2);
      };
      reader.readAsText(file);
    } else {
      alert("Please drop a valid CSV file.");
    }
  });
</script>