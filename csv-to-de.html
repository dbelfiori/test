<h2>üìã Paste Campaign CSV Content</h2>
<form method="post">
  <textarea name="csvText" rows="12" cols="100" placeholder="Paste CSV here..." required></textarea>
  <br><br>
  <input type="submit" value="Preview and Upsert" />
</form>

%%[
SET @csvContent = RequestParameter("csvText")
SET @deName = "db-SS-Tracker"

IF NOT EMPTY(@csvContent) THEN
  SET @lines = BuildRowsetFromString(@csvContent, "\n")
  SET @rowCount = RowCount(@lines)

  IF @rowCount > 1 THEN
    SET @inserted = 0

    /* Define expected headers in order */
    SET @expectedHeaders = BuildRowsetFromString("FISCAL_WEEK_ID,Promo Start/Deploy Date,Deploy Time,Media Type,Campaign Type,Campaign Name,Campaign Manager,Audience Prepared by,Developer,Checklist,Campaign Producer,Creative Job #,Creative DUE -  modify days/logic,Campaign Scheduled (Actual Date)", ",")

    OUTPUT("<table border='1'><thead><tr>")
    FOR @h = 1 TO RowCount(@expectedHeaders) DO
      SET @header = Field(Row(@expectedHeaders, @h), 1)
      OUTPUT(CONCAT("<th>", @header, "</th>"))
    NEXT @h
    OUTPUT("</tr></thead><tbody>")

    FOR @i = 2 TO @rowCount DO
      SET @line = Row(@lines, @i)
      SET @fields = BuildRowsetFromString(@line, ",")

      IF RowCount(@fields) >= 14 THEN
        /* Display row */
        OUTPUT("<tr>")
        FOR @j = 1 TO 14 DO
          SET @value = Field(Row(@fields, @j), 1)
          OUTPUT(CONCAT("<td>", @value, "</td>"))
        NEXT @j
        OUTPUT("</tr>")

        /* Map fields */
        SET @FISCAL_WEEK_ID = Field(Row(@fields, 1), 1)
        SET @Promo_StartDeployDate = Field(Row(@fields, 2), 1)
        SET @Deploy_Time = Field(Row(@fields, 3), 1)
        SET @Media_Type = Field(Row(@fields, 4), 1)
        SET @Campaign_Type = Field(Row(@fields, 5), 1)
        SET @Campaign_Name = Field(Row(@fields, 6), 1)
        SET @Campaign_Manager = Field(Row(@fields, 7), 1)
        SET @Audience_Prepared_by = Field(Row(@fields, 8), 1)
        SET @Developer = Field(Row(@fields, 9), 1)
        SET @Checklist = Field(Row(@fields, 10), 1)
        SET @Campaign_Producer = Field(Row(@fields, 11), 1)
        SET @Creative_Job_ = Field(Row(@fields, 12), 1)
        SET @Creative_DUE_modify_dayslogic = Field(Row(@fields, 13), 1)
        SET @Campaign_Scheduled_Actual_Date = Field(Row(@fields, 14), 1)

        IF NOT EMPTY(@Campaign_Name) THEN
          UPSERTDE(@deName, 1, "Campaign_Name", @Campaign_Name,
            "FISCAL_WEEK_ID", @FISCAL_WEEK_ID,
            "Promo_StartDeployDate", @Promo_StartDeployDate,
            "Deploy_Time", @Deploy_Time,
            "Media_Type", @Media_Type,
            "Campaign_Type", @Campaign_Type,
            "Campaign_Manager", @Campaign_Manager,
            "Audience_Prepared_by", @Audience_Prepared_by,
            "Developer", @Developer,
            "Checklist", @Checklist,
            "Campaign_Producer", @Campaign_Producer,
            "Creative_Job_", @Creative_Job_,
            "Creative_DUE____modify_dayslogic", @Creative_DUE_modify_dayslogic,
            "Campaign_Scheduled_Actual_Date", @Campaign_Scheduled_Actual_Date
          )
          SET @inserted = Add(@inserted, 1)
        ENDIF
      ENDIF
    NEXT @i

    OUTPUT("</tbody></table>")
    OUTPUT(CONCAT("<p style='color:green;'>‚úÖ Upserted ", @inserted, " rows into ", @deName, ".</p>"))
  ELSE
    OUTPUT("<p style='color:red;'>‚ùå CSV must contain a header and at least one data row.</p>")
  ENDIF
ELSE
  OUTPUT("<p>üïí Waiting for CSV input...</p>")
ENDIF
]%%

<script>
document.addEventListener("DOMContentLoaded", function () {
  const textarea = document.querySelector('textarea[name="csvText"]');

  const allowedHeaders = [
    "FISCAL_WEEK_ID",
    "Promo Start/Deploy Date",
    "Deploy Time",
    "Media Type",
    "Campaign Type",
    "Campaign Name",
    "Campaign Manager",
    "Audience Prepared by",
    "Developer",
    "Checklist",
    "Campaign Producer",
    "Creative Job #",
    "Creative DUE -  modify days/logic",
    "Campaign Scheduled (Actual Date)"
  ];

  textarea.addEventListener("paste", function (e) {
    e.preventDefault();

    const pastedText = (e.clipboardData || window.clipboardData).getData("text");
    const lines = pastedText.split(/\r?\n/);
    if (lines.length < 2) return;

    const rawHeaders = lines[0].split(",");
    const headerMap = {};

    // Build map of allowed header indexes
    rawHeaders.forEach((header, index) => {
      const trimmed = header.trim();
      if (allowedHeaders.includes(trimmed)) {
        headerMap[index] = trimmed;
      }
    });

    // Rebuild CSV with only allowed columns
    const cleanedLines = lines.map(line => {
      const cols = line.split(",");
      const filtered = Object.keys(headerMap).map(i => cols[i] || "");
      return filtered.join(",");
    });

    textarea.value = cleanedLines.join("\n");
  });
});
</script>