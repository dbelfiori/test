<h2>üì• Upload CSV to Preview and Upsert</h2>
<form method="post" enctype="multipart/form-data">
  <input type="file" name="csvfile" accept=".csv" required />
  <br><br>
  <input type="submit" value="Upload and Preview" />
</form>

<script runat="server">
Platform.Load("Core", "1.1.1");

var csvContent = "";
try {
  var uploadedFile = Request.GetUploadedFile("csvfile");
  if (uploadedFile && uploadedFile.Content && uploadedFile.Content.length > 0) {
    csvContent = uploadedFile.Content;
  }
} catch (e) {
  csvContent = "ERROR: " + String(e);
}

Variable.SetValue("csvContent", csvContent);
</script>

%%[
SET @csvContent = AttributeValue("csvContent")
SET @deName = "YourDataExtensionName"

IF IndexOf(@csvContent, "ERROR:") == 0 THEN
  OUTPUT(CONCAT("<p style='color:red;'>", @csvContent, "</p>"))
ELSEIF NOT EMPTY(@csvContent) THEN
  SET @lines = BuildRowsetFromString(@csvContent, "\n")
  SET @rowCount = RowCount(@lines)

  IF @rowCount > 1 THEN
    SET @headerRow = Row(@lines, 1)
    SET @headers = BuildRowsetFromString(@headerRow, ",")
    SET @fieldCount = RowCount(@headers)
    SET @inserted = 0

    /* Display table header */
    OUTPUT("<table border='1' cellpadding='5' cellspacing='0'><thead><tr>")
    FOR @h = 1 TO @fieldCount DO
      SET @header = Field(Row(@headers, @h), 1)
      OUTPUT(CONCAT("<th>", @header, "</th>"))
    NEXT @h
    OUTPUT("</tr></thead><tbody>")

    /* Loop through rows */
    FOR @i = 2 TO @rowCount DO
      SET @line = Row(@lines, @i)
      SET @fields = BuildRowsetFromString(@line, ",")

      IF RowCount(@fields) == @fieldCount THEN
        OUTPUT("<tr>")
        FOR @j = 1 TO @fieldCount DO
          SET @value = Field(Row(@fields, @j), 1)
          OUTPUT(CONCAT("<td>", @value, "</td>"))
        NEXT @j
        OUTPUT("</tr>")

        /* Static mapping ‚Äî adjust to match your DE */
        SET @email = Field(Row(@fields, 1), 1)
        SET @firstName = Field(Row(@fields, 2), 1)
        SET @lastName = Field(Row(@fields, 3), 1)

        IF NOT EMPTY(@email) THEN
          UPSERTDE(@deName, 1, "Email", @email, "FirstName", @firstName, "LastName", @lastName)
          SET @inserted = Add(@inserted, 1)
        ENDIF
      ENDIF
    NEXT @i

    OUTPUT("</tbody></table>")
    OUTPUT(CONCAT("<p style='color:green;'>‚úÖ Upserted ", @inserted, " rows into ", @deName, ".</p>"))
  ELSE
    OUTPUT("<p style='color:red;'>‚ùå CSV must contain a header and at least one data row.</p>")
  ENDIF
ELSE
  OUTPUT("<p style='color:red;'>‚ùå No CSV content found. Make sure the file was uploaded correctly.</p>")
ENDIF
]%%