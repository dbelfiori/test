<form method="post" enctype="multipart/form-data">
  <input type="file" name="csvfile" accept=".csv" required />
  <br><br>
  <input type="submit" value="Upload and Upsert" />
</form>
<script runat="server">
Platform.Load("Core", "1.1.1");

var uploadedFile = Request.GetUploadedFile("csvfile");
var csvContent = "";

if (uploadedFile && uploadedFile.Content && uploadedFile.Content.length > 0) {
  csvContent = uploadedFile.Content;
} else {
  csvContent = "ERROR: No file uploaded or file is empty";
}

Variable.SetValue("csvContent", csvContent);
</script>

%%[
SET @csvContent = AttributeValue("csvContent")
SET @deName = "YourDataExtensionName"

IF IndexOf(@csvContent, "ERROR:") == 0 THEN
  SET @lines = BuildRowsetFromString(@csvContent, "\n")
  SET @rowCount = RowCount(@lines)

  IF @rowCount > 1 THEN
    SET @inserted = 0

    FOR @i = 2 TO @rowCount DO
      SET @line = Row(@lines, @i)
      SET @fields = BuildRowsetFromString(@line, ",")

      IF RowCount(@fields) >= 3 THEN
        SET @email = Field(Row(@fields, 1), 1)
        SET @firstName = Field(Row(@fields, 2), 1)
        SET @lastName = Field(Row(@fields, 3), 1)

        IF NOT EMPTY(@email) THEN
          UPSERTDE(@deName, 1, "Email", @email, "FirstName", @firstName, "LastName", @lastName)
          SET @inserted = Add(@inserted, 1)
        ENDIF
      ENDIF
    NEXT @i

    OUTPUT(CONCAT("<p style='color:green;'>✅ Upserted ", @inserted, " rows into ", @deName, ".</p>"))
  ELSE
    OUTPUT("<p style='color:red;'>❌ CSV must contain a header and at least one data row.</p>")
  ENDIF
ELSE
  OUTPUT(CONCAT("<p style='color:red;'>", @csvContent, "</p>"))
ENDIF
]%%