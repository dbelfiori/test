<h2>ðŸ“‹ Paste Campaign CSV Content</h2>
<textarea id="csvInput" rows="12" cols="100" placeholder="Paste CSV here..."></textarea>
<br><br>
<button id="cleanButton">Clean CSV</button>

<h3>âœ… Cleaned Output</h3>
<textarea id="cleanedOutput" rows="12" cols="100" readonly></textarea>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("csvInput");
  const output = document.getElementById("cleanedOutput");
  const button = document.getElementById("cleanButton");

  const allowedHeaders = [
    "FISCAL_WEEK_ID",
    "Promo Start/Deploy Date",
    "Deploy Time",
    "Media Type",
    "Campaign Type",
    "Campaign Name",
    "Campaign Manager",
    "Audience Prepared by",
    "Developer",
    "Checklist",
    "Campaign Producer",
    "Creative Job #",
    "Creative DUE -  modify days/logic",
    "Campaign Scheduled (Actual Date)"
  ];

  button.addEventListener("click", function () {
    const pastedText = input.value;
    const lines = pastedText.split(/\r?\n/);
    if (lines.length < 2) return;

    const rawHeaders = lines[0].split(",");
    const headerMap = {};
    let promoDateIndex = -1;

    rawHeaders.forEach((header, index) => {
      const trimmed = header.trim();
      if (allowedHeaders.includes(trimmed)) {
        headerMap[index] = trimmed;
        if (trimmed === "Promo Start/Deploy Date") {
          promoDateIndex = index;
        }
      }
    });

    if (promoDateIndex === -1) {
      output.value = "âš ï¸ Missing 'Promo Start/Deploy Date' column.";
      return;
    }

    const today = new Date();
    const cutoff = new Date(today);
    cutoff.setDate(cutoff.getDate() - 30);

    const cleanedLines = [];
    cleanedLines.push(Object.keys(headerMap).map(i => rawHeaders[i].trim()).join(","));

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      if (cols.length < rawHeaders.length) continue;

      const promoDateRaw = cols[promoDateIndex]?.trim();
      const promoDateClean = promoDateRaw.replace(/^[A-Za-z]+[\s]+/, "");
      const [month, day, year] = promoDateClean.split("/").map(s => parseInt(s));
      const promoDate = new Date(year, month - 1, day);

      if (promoDateRaw && !isNaN(promoDate) && promoDate >= cutoff) {
        const filtered = Object.keys(headerMap).map(i => cols[i] || "");
        cleanedLines.push(filtered.join(","));
      }
    }

    output.value = cleanedLines.join("\n");
  });
});
</script>