<h2>üì• Upload Campaign CSV to Preview and Upsert</h2>
<form method="post" enctype="multipart/form-data">
  <input type="file" name="csvfile" accept=".csv" required />
  <br><br>
  <input type="submit" value="Upload and Preview" />
</form>

<script runat="server">
Platform.Load("Core", "1.1.1");

// Header sanitizer: replaces spaces/dashes with underscores, removes all other non-alphanumerics except underscore
function sanitizeHeader(header) {
  return header
    .trim()
    .replace(/[\s\-]/g, "_")
    .replace(/[^A-Za-z0-9_]/g, "");
}

var htmlTable = "";
var rowCount = 0;

try {
  var uploadedFile = Request.GetUploadedFile("csvfile");

  if (uploadedFile && uploadedFile.Content && uploadedFile.Content.length > 0) {
    var csvContent = uploadedFile.Content;
    var lines = csvContent.split(/\r?\n/);
    var rawHeaders = lines[0].split(",");
    var headers = [];

    for (var h = 0; h < rawHeaders.length; h++) {
      headers[h] = sanitizeHeader(rawHeaders[h]);
    }

    htmlTable += "<table border='1' cellpadding='5' cellspacing='0'><thead><tr>";
    for (var h = 0; h < headers.length; h++) {
      htmlTable += "<th>" + headers[h] + "</th>";
    }
    htmlTable += "</tr></thead><tbody>";

    for (var i = 1; i < lines.length; i++) {
      var row = lines[i].split(",");
      if (row.length !== headers.length) continue;

      htmlTable += "<tr>";
      for (var j = 0; j < row.length; j++) {
        htmlTable += "<td>" + row[j].trim() + "</td>";
      }
      htmlTable += "</tr>";

      for (var k = 0; k < headers.length; k++) {
        Variable.SetValue(headers[k] + "_" + i, row[k].trim());
      }
      rowCount++;
    }

    htmlTable += "</tbody></table>";
    Variable.SetValue("rowCount", rowCount);
  }
} catch (e) {
  htmlTable = "<p style='color:red;'>‚ö†Ô∏è Error reading file: " + String(e) + "</p>";
}

Write(htmlTable);
</script>

%%[
SET @deName = "db-SS-Tracker"
SET @rowCount = AttributeValue("rowCount")

IF NOT EMPTY(@rowCount) THEN
  SET @inserted = 0

  FOR @i = 1 TO @rowCount DO
    SET @FISCAL_WEEK_ID = AttributeValue(CONCAT("FISCAL_WEEK_ID_", @i))
    SET @Promo_StartDeployDate = AttributeValue(CONCAT("Promo_StartDeployDate_", @i))
    SET @Deploy_Time = AttributeValue(CONCAT("Deploy_Time_", @i))
    SET @Media_Type = AttributeValue(CONCAT("Media_Type_", @i))
    SET @Campaign_Type = AttributeValue(CONCAT("Campaign_Type_", @i))
    SET @Campaign_Name = AttributeValue(CONCAT("Campaign_Name_", @i))
    SET @Campaign_Manager = AttributeValue(CONCAT("Campaign_Manager_", @i))
    SET @Audience_Prepared_by = AttributeValue(CONCAT("Audience_Prepared_by_", @i))
    SET @Developer = AttributeValue(CONCAT("Developer_", @i))
    SET @Checklist = AttributeValue(CONCAT("Checklist_", @i))
    SET @Campaign_Producer = AttributeValue(CONCAT("Campaign_Producer_", @i))
    SET @Creative_Job_ = AttributeValue(CONCAT("Creative_Job__", @i))
    SET @Creative_DUE____modify_dayslogic = AttributeValue(CONCAT("Creative_DUE____modify_dayslogic_", @i))
    SET @Campaign_Scheduled_Actual_Date = AttributeValue(CONCAT("Campaign_Scheduled_Actual_Date_", @i))

    IF NOT EMPTY(@Campaign_Name) THEN
      UPSERTDE(@deName, 1, "Campaign_Name", @Campaign_Name,
        "FISCAL_WEEK_ID", @FISCAL_WEEK_ID,
        "Promo_StartDeployDate", @Promo_StartDeployDate,
        "Deploy_Time", @Deploy_Time,
        "Media_Type", @Media_Type,
        "Campaign_Type", @Campaign_Type,
        "Campaign_Manager", @Campaign_Manager,
        "Audience_Prepared_by", @Audience_Prepared_by,
        "Developer", @Developer,
        "Checklist", @Checklist,
        "Campaign_Producer", @Campaign_Producer,
        "Creative_Job_", @Creative_Job_,
        "Creative_DUE____modify_dayslogic", @Creative_DUE____modify_dayslogic,
        "Campaign_Scheduled_Actual_Date", @Campaign_Scheduled_Actual_Date
      )
      SET @inserted = Add(@inserted, 1)
    ENDIF
  NEXT @i

  OUTPUT(CONCAT("<p style='color:green;'>‚úÖ Upserted ", @inserted, " rows into ", @deName, ".</p>"))
ENDIF
]%%